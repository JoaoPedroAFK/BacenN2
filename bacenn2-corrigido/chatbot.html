<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Chatbot - Sistema Velotax</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/theme-dark.css">
    
    <!-- Script Inline: Definir buscarClientePorCPF ANTES do body ser renderizado -->
    <script>
        // Definir buscarClientePorCPF ANTES do body ser renderizado
        // Isso evita erro quando o HTML tenta chamar a fun√ß√£o no onclick
        window.buscarClientePorCPF = async function() {
            // Verificar se historicoCliente j√° est√° dispon√≠vel
            if (window.historicoCliente && typeof window.historicoCliente.mostrarHistorico === 'function') {
                const input = document.getElementById('busca-cliente-cpf');
                const cpf = input ? input.value.trim() : '';
                if (cpf) {
                    const cpfLimpo = cpf.replace(/\D/g, '');
                    if (cpfLimpo.length < 11) {
                        if (typeof mostrarAlerta === 'function') {
                            mostrarAlerta('CPF inv√°lido. Digite os 11 d√≠gitos.', 'warning');
                        } else {
                            alert('CPF inv√°lido. Digite os 11 d√≠gitos.');
                        }
                        return;
                    }
                    await window.historicoCliente.mostrarHistorico(cpf);
                    if (input) input.value = '';
                } else {
                    if (typeof mostrarAlerta === 'function') {
                        mostrarAlerta('Digite um CPF para buscar', 'info');
                    } else {
                        alert('Digite um CPF para buscar');
                    }
                }
            } else {
                console.warn('‚ö†Ô∏è historicoCliente ainda n√£o est√° dispon√≠vel, aguardando...');
                // Aguardar um pouco e tentar novamente
                setTimeout(() => {
                    if (window.historicoCliente) {
                        window.buscarClientePorCPF();
                    } else {
                        alert('Sistema ainda carregando. Tente novamente em alguns segundos.');
                    }
                }, 500);
            }
        };
        console.log('‚úÖ buscarClientePorCPF definido globalmente no <head> (chatbot.html)');
    </script>
    
    <!-- Script Inline: Definir mostrarSecao ANTES dos bot√µes serem renderizados -->
    <script>
        // Fun√ß√£o mostrarSecao deve estar dispon√≠vel GLOBALMENTE antes dos bot√µes
        // Esta fun√ß√£o ser√° sobrescrita/refor√ßada pelo chatbot-page.js quando carregar
        (function() {
            'use strict';
            window.mostrarSecao = function(secaoId) {
                console.log('üîò [HEAD] mostrarSecao chamado com:', secaoId);
                
                // Esconder todas as se√ß√µes
                const sections = document.querySelectorAll('.section');
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                
                // Remover active de todos os bot√µes
                const buttons = document.querySelectorAll('.nav-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Mostrar se√ß√£o selecionada
                const section = document.getElementById(secaoId);
                if (section) {
                    section.classList.add('active');
                } else {
                    console.warn('‚ö†Ô∏è Se√ß√£o n√£o encontrada:', secaoId);
                }
                
                // Ativar bot√£o correspondente
                buttons.forEach(btn => {
                    const onclick = btn.getAttribute('onclick');
                    if (onclick && onclick.includes(`'${secaoId}'`)) {
                        btn.classList.add('active');
                    }
                });
                
                // Chamar fun√ß√µes espec√≠ficas de cada se√ß√£o
                if (secaoId === 'lista-chatbot') {
                    console.log('üìã [HEAD] Se√ß√£o lista-chatbot selecionada, chamando renderizarListaChatbot...');
                    // Verificar se a fun√ß√£o existe antes de chamar
                    if (typeof window.renderizarListaChatbot === 'function') {
                        console.log('‚úÖ [HEAD] Chamando window.renderizarListaChatbot...');
                        window.renderizarListaChatbot();
                    } else if (typeof renderizarListaChatbot === 'function') {
                        console.log('‚úÖ [HEAD] Chamando renderizarListaChatbot...');
                        renderizarListaChatbot();
                    } else {
                        console.warn('‚ö†Ô∏è [HEAD] renderizarListaChatbot n√£o est√° dispon√≠vel ainda');
                        console.warn('‚ö†Ô∏è [HEAD] typeof window.renderizarListaChatbot:', typeof window.renderizarListaChatbot);
                        console.warn('‚ö†Ô∏è [HEAD] typeof renderizarListaChatbot:', typeof renderizarListaChatbot);
                        // Tentar novamente ap√≥s um pequeno delay
                        setTimeout(() => {
                            if (typeof window.renderizarListaChatbot === 'function') {
                                console.log('‚úÖ [HEAD] Chamando window.renderizarListaChatbot ap√≥s delay...');
                                window.renderizarListaChatbot();
                            } else if (typeof renderizarListaChatbot === 'function') {
                                console.log('‚úÖ [HEAD] Chamando renderizarListaChatbot ap√≥s delay...');
                                renderizarListaChatbot();
                            } else {
                                console.error('‚ùå [HEAD] renderizarListaChatbot ainda n√£o est√° dispon√≠vel ap√≥s delay');
                            }
                        }, 1000);
                    }
                } else if (secaoId === 'minhas-reclamacoes-chatbot') {
                    if (typeof window.renderizarMinhasReclamacoesChatbot === 'function') {
                        window.renderizarMinhasReclamacoesChatbot();
                    } else if (typeof renderizarMinhasReclamacoesChatbot === 'function') {
                        renderizarMinhasReclamacoesChatbot();
                    }
                } else if (secaoId === 'dashboard-chatbot') {
                    // Aguardar um pouco para garantir que armazenamentoReclamacoes est√° pronto
                    setTimeout(async () => {
                    if (typeof window.atualizarDashboardChatbot === 'function') {
                            await window.atualizarDashboardChatbot();
                    } else if (typeof atualizarDashboardChatbot === 'function') {
                            await atualizarDashboardChatbot();
                    }
                    }, 500);
                }
            };
            console.log('‚úÖ [HEAD] mostrarSecao definido globalmente no <head>');
            console.log('‚úÖ [HEAD] typeof window.mostrarSecao:', typeof window.mostrarSecao);
        })();
    </script>
    
    <style>
        /* Estilos espec√≠ficos Chatbot */
        .chatbot-header {
            background: linear-gradient(135deg, #1634FF 0%, #1DFDB9 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .chatbot-card {
            border-left: 4px solid #1634FF;
        }
        
        .chatbot-badge {
            background: #1634FF;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="velohub-header">
        <div class="header-content">
                <div class="header-logo">
                    <div class="logo-container">
                        <img src="img/simbolo_velotax_ajustada_branco.png" alt="Velotax" class="logo-header">
                    </div>
                    <h1>Chatbot</h1>
                </div>
            <div class="header-actions">
                <a href="index.html" class="velohub-btn btn-secondary" style="text-decoration: none; color: white; margin-right: 12px;">üè† Voltar √† Home</a>
                <button class="theme-toggle-btn" onclick="toggleTheme()">üåô</button>
            </div>
        </div>
    </header>

    <!-- Menu CANAIS -->
    <nav class="nav nav-canais">
        <div class="canais-menu">
            <span class="canais-label">CANAIS:</span>
            <a href="bacen.html" class="nav-btn canais-btn">BACEN</a>
            <a href="n2.html" class="nav-btn canais-btn">N2</a>
            <a href="chatbot.html" class="nav-btn canais-btn active">Chatbot</a>
        </div>
        <div class="busca-cliente-inline">
            <input type="text" id="busca-cliente-cpf" class="velohub-input busca-cliente-input" placeholder="üîç Buscar cliente por CPF..." onkeypress="if(event.key === 'Enter') buscarClientePorCPF()">
            <button class="velohub-btn btn-secondary btn-buscar-cliente" onclick="buscarClientePorCPF()">Buscar</button>
        </div>
    </nav>

    <!-- Navega√ß√£o -->
    <nav class="nav">
        <button class="nav-btn active" onclick="mostrarSecao('dashboard-chatbot')">üìä Dashboard</button>
        <button class="nav-btn" onclick="mostrarSecao('minhas-reclamacoes-chatbot')">üë§ Minhas Reclama√ß√µes</button>
        <button class="nav-btn" onclick="mostrarSecao('nova-reclamacao-chatbot')">‚ûï Nova Reclama√ß√£o Chatbot</button>
        <button class="nav-btn" onclick="mostrarSecao('lista-chatbot')">üìã Lista de Reclama√ß√µes</button>
        <button class="nav-btn" onclick="mostrarSecao('relatorios-chatbot')">üìà Relat√≥rios</button>
    </nav>

    <!-- Container Principal -->
    <main class="velohub-container">
        <!-- Dashboard Chatbot -->
        <section id="dashboard-chatbot" class="section active">
            <div class="chatbot-header">
                <h2>üìä Dashboard Chatbot</h2>
                <p>M√©tricas e estat√≠sticas das demandas originadas no chatbot</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card chatbot-card">
                    <h3>Total de Reclama√ß√µes Chatbot</h3>
                    <span class="stat-number" id="chatbot-total-dash">0</span>
                </div>
                <div class="stat-card chatbot-card">
                    <h3>Resolvidas Automaticamente</h3>
                    <span class="stat-number" id="chatbot-auto-resolvidas">0</span>
                </div>
                <div class="stat-card chatbot-card">
                    <h3>Encaminhadas para Humano</h3>
                    <span class="stat-number" id="chatbot-encaminhadas">0</span>
                </div>
                <div class="stat-card chatbot-card">
                    <h3>Taxa de Satisfa√ß√£o</h3>
                    <span class="stat-number" id="chatbot-satisfacao">0%</span>
                </div>
            </div>

            <!-- M√©tricas Espec√≠ficas Chatbot -->
            <div class="metricas-chatbot">
                <h3>üìä M√©tricas Espec√≠ficas Chatbot</h3>
                <div class="metricas-grid">
                    <div class="metrica-card">
                        <h4>Taxa de Resolu√ß√£o Autom√°tica</h4>
                        <div class="metrica-valor" id="taxa-auto-chatbot">0%</div>
                    </div>
                    <div class="metrica-card">
                        <h4>Canal Mais Usado</h4>
                        <div class="metrica-valor" id="canal-mais-usado">-</div>
                    </div>
                    <div class="metrica-card">
                        <h4>M√©dia de Satisfa√ß√£o</h4>
                        <div class="metrica-valor" id="media-satisfacao">0.0</div>
                    </div>
                    <div class="metrica-card">
                        <h4>Tempo M√©dio de Resposta</h4>
                        <div class="metrica-valor" id="tempo-resposta-chatbot">0 min</div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos Chatbot -->
            <div class="graficos-chatbot">
                <div class="grafico-card">
                    <h3>Resolu√ß√£o Autom√°tica vs Humana</h3>
                    <div id="grafico-resolucao-chatbot"></div>
                </div>
                <div class="grafico-card">
                    <h3>Distribui√ß√£o por Canal</h3>
                    <div id="grafico-canais-chatbot"></div>
                </div>
            </div>
        </section>

        <!-- Minhas Reclama√ß√µes Chatbot -->
        <section id="minhas-reclamacoes-chatbot" class="section">
            <div class="chatbot-header">
                <h2>üë§ Minhas Reclama√ß√µes Chatbot</h2>
                <p>Reclama√ß√µes atribu√≠das a voc√™</p>
            </div>
            
            <div id="minhas-fichas-chatbot" class="fichas-container">
                <div class="loading-message">Carregando suas reclama√ß√µes...</div>
            </div>
        </section>

        <!-- Nova Reclama√ß√£o Chatbot -->
        <section id="nova-reclamacao-chatbot" class="section">
            <div class="chatbot-header">
                <h2>‚ûï Nova Reclama√ß√£o Chatbot</h2>
                <p>Registre uma nova demanda originada no chatbot</p>
            </div>
            
            <form id="form-chatbot" class="complaint-form">
                <!-- Dados B√°sicos -->
                <div class="form-section">
                    <h3>Dados B√°sicos</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chatbot-data-cliente">Data entrada *</label>
                            <input type="date" id="chatbot-data-cliente" class="velohub-input" required>
                        </div>
                        <!-- Respons√°vel ser√° preenchido automaticamente com o usu√°rio logado -->
                        <input type="hidden" id="chatbot-responsavel">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chatbot-nome">Nome Completo *</label>
                            <input type="text" id="chatbot-nome" class="velohub-input" required>
                        </div>
                        <div class="form-group">
                            <label for="chatbot-cpf">CPF (000.000.000-00) *</label>
                            <input type="text" id="chatbot-cpf" class="velohub-input cpf-mask" required placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Telefone (DDD) 00000-0000</label>
                            <div id="chatbot-telefones-container">
                                <input type="text" class="velohub-input telefone-mask telefone-input" placeholder="(00) 00000-0000">
                            </div>
                            <button type="button" class="btn-adicionar-telefone" onclick="adicionarTelefone('chatbot-telefones-container')" style="margin-top: 8px; padding: 6px 12px; background: var(--azul-royal); color: white; border: none; border-radius: 4px; cursor: pointer;">+ Adicionar Telefone</button>
                        </div>
                    </div>
                </div>

                <!-- Detalhes da Avalia√ß√£o -->
                <div class="form-section">
                    <h3>Detalhes da Avalia√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chatbot-nota-avaliacao">Nota de Avalia√ß√£o</label>
                            <select id="chatbot-nota-avaliacao" class="velohub-input">
                                <option value="">Selecione...</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chatbot-produto">Produto</label>
                            <select id="chatbot-produto" class="velohub-input">
                                <option value="">Selecione...</option>
                                <option value="Antecipa√ß√£o">Antecipa√ß√£o</option>
                                <option value="Aplicativo">Aplicativo</option>
                                <option value="Calculadora">Calculadora</option>
                                <option value="Cr√©dito do Trabalhador">Cr√©dito do Trabalhador</option>
                                <option value="Empr√©stimo Pessoal">Empr√©stimo Pessoal</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chatbot-motivo">Motivo</label>
                            <select id="chatbot-motivo" class="velohub-input">
                                <option value="">Selecione...</option>
                                <option value="Calculadora">Calculadora</option>
                                <option value="Chave PIX">Chave PIX</option>
                                <option value="Conta">Conta</option>
                                <option value="D√©bito em Aberto">D√©bito em Aberto</option>
                                <option value="Elegibilidade">Elegibilidade</option>
                                <option value="Encerramento da Cadastro">Encerramento da Cadastro</option>
                                <option value="Erros ‚Äì Bugs">Erros ‚Äì Bugs</option>
                                <option value="Fraude">Fraude</option>
                                <option value="Open Finance">Open Finance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Resposta do Bot</label>
                            <div style="display: flex; gap: 16px; margin-top: 8px;">
                                <label class="radio-label">
                                    <input type="radio" name="chatbot-resposta-bot" value="Sim" onchange="toggleObservacaoRespostaBot()">
                                    <span>Sim</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="chatbot-resposta-bot" value="N√£o" onchange="toggleObservacaoRespostaBot()">
                                    <span>N√£o</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="chatbot-observacao-resposta-bot" class="form-group" style="display: none;">
                        <label for="chatbot-observacao-resposta-bot-texto">Observa√ß√£o</label>
                        <textarea id="chatbot-observacao-resposta-bot-texto" class="velohub-input" rows="4" placeholder="Digite a observa√ß√£o sobre a resposta do bot..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="chatbot-avaliacao-cliente">Avalia√ß√£o do Cliente (campo aberto)</label>
                        <textarea id="chatbot-avaliacao-cliente" class="velohub-input" rows="4" placeholder="Digite a avalia√ß√£o do cliente..."></textarea>
                    </div>
                </div>

                <!-- Libera√ß√£o do PIX -->
                <div class="form-section">
                    <h3>Libera√ß√£o do PIX</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chatbot-pix-status">PIX liberado ou exclu√≠do?</label>
                            <select id="chatbot-pix-status" class="velohub-input">
                                <option value="">Selecione...</option>
                                <option value="Liberado">Liberado</option>
                                <option value="Exclu√≠do">Exclu√≠do</option>
                                <option value="Solicitada">Solicitada</option>
                                <option value="N√£o aplic√°vel">N√£o aplic√°vel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Enviar para cobran√ßa? *</label>
                            <div style="display: flex; gap: 16px; margin-top: 8px;">
                                <label class="radio-label">
                                    <input type="radio" name="chatbot-enviar-cobranca" value="Sim" required>
                                    <span>Sim</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="chatbot-enviar-cobranca" value="N√£o" required>
                                    <span>N√£o</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observa√ß√µes -->
                <div class="form-section">
                    <h3>Observa√ß√µes</h3>
                    <div class="form-group">
                        <label for="chatbot-observacoes">Observa√ß√µes</label>
                        <textarea id="chatbot-observacoes" class="velohub-input" rows="4" placeholder="Digite as observa√ß√µes..."></textarea>
                    </div>
                </div>

                <!-- Casos Cr√≠ticos (Blacklist) -->
                <div class="form-section">
                    <h3>Casos Cr√≠ticos (Blacklist)</h3>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="chatbot-casos-criticos">
                            <span class="checkmark"></span>
                            Blacklist
                        </label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="velohub-btn">üíæ Salvar Reclama√ß√£o Chatbot</button>
                    <button type="button" class="velohub-btn btn-secondary" onclick="limparFormChatbot()">üóëÔ∏è Limpar</button>
                </div>
            </form>
        </section>

        <!-- Lista de Reclama√ß√µes Chatbot -->
        <section id="lista-chatbot" class="section">
            <div class="chatbot-header">
                <h2>üìã Lista de Reclama√ß√µes Chatbot</h2>
                <p>Todas as demandas originadas no chatbot</p>
            </div>
            
            <div class="list-controls">
                <div class="search-box">
                    <input type="text" id="busca-chatbot" class="velohub-input" placeholder="üîç Buscar por nome, CPF ou motivo...">
                </div>
                <div class="filter-controls">
                    <select id="filtro-status-chatbot" class="velohub-input">
                        <option value="" selected>Todos os Status</option>
                        <option value="nao-iniciado">N√£o Iniciado</option>
                        <option value="em-tratativa">Em Tratativa</option>
                        <option value="concluido">Conclu√≠do</option>
                        <option value="respondido">Respondido</option>
                    </select>
                    <select id="filtro-canal-chatbot" class="velohub-input">
                        <option value="" selected>Todos os Canais</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="telegram">Telegram</option>
                        <option value="site">Site</option>
                        <option value="app">App</option>
                    </select>
                </div>
            </div>
            
            <div id="lista-fichas-chatbot" class="complaints-list">
                <!-- Lista ser√° populada dinamicamente -->
            </div>
        </section>

        <!-- Relat√≥rios Chatbot -->
        <section id="relatorios-chatbot" class="section">
            <div class="chatbot-header">
                <h2>üìà Relat√≥rios Chatbot</h2>
                <p>Relat√≥rios espec√≠ficos para demandas do chatbot</p>
            </div>
            
            <div class="reports-grid">
                <div class="report-card">
                    <h3>üìä Relat√≥rio por Per√≠odo</h3>
                    <p>An√°lise temporal das demandas</p>
                    <button class="velohub-btn" onclick="gerarRelatorioPeriodoChatbot()">Gerar Relat√≥rio</button>
                </div>
                <div class="report-card">
                    <h3>ü§ñ Relat√≥rio de Resolu√ß√£o Autom√°tica</h3>
                    <p>Fichas resolvidas automaticamente</p>
                    <button class="velohub-btn" onclick="gerarRelatorioAutoChatbot()">Gerar Relat√≥rio</button>
                </div>
                <div class="report-card">
                    <h3>‚≠ê Relat√≥rio de Satisfa√ß√£o</h3>
                    <p>An√°lise de satisfa√ß√£o dos clientes</p>
                    <button class="velohub-btn" onclick="gerarRelatorioSatisfacaoChatbot()">Gerar Relat√≥rio</button>
                </div>
                <div class="report-card">
                    <h3>üìã Relat√≥rio Completo</h3>
                    <p>Todas as fichas Chatbot</p>
                    <button class="velohub-btn" onclick="gerarRelatorioCompletoChatbot()">Gerar Relat√≥rio</button>
                </div>
            </div>
            
            <div id="conteudo-relatorio-chatbot" class="report-content" style="display: none;">
                <!-- Conte√∫do do relat√≥rio ser√° exibido aqui -->
            </div>
        </section>
    </main>

    <!-- JavaScript -->
    <!-- Configura√ß√£o Google SSO -->
    <script>
        window.GOOGLE_CLIENT_ID = '638842930106-b0plff0sbbs0ljsm39n5kadsjfcj3u3q.apps.googleusercontent.com';
    </script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="js/config-firebase.js"></script>
    <!-- Firebase Manager Corrigido - Aguarda inicializa√ß√£o completa -->
    <script src="js/firebase-init-v2.js"></script>
    <script src="js/firebase-db.js"></script>
    <!-- Outros scripts -->
    <script src="js/loading.js"></script>
    <script src="js/validador-velotax.js"></script>
    <script src="js/google-sso.js"></script>
    <script src="js/auth-system.js"></script>
    <script src="js/gerenciador-fichas-perfil.js"></script>
    <script src="js/gerenciador-anexos.js"></script>
    <script src="js/fichas-especificas.js"></script>
    <script src="js/armazenamento-reclamacoes.js"></script>
    <!-- Definir renderizarListaChatbot antes de carregar chatbot-page.js para garantir disponibilidade -->
    <script>
        // Vers√£o stub que ser√° sobrescrita pelo chatbot-page.js se carregar corretamente
        window.renderizarListaChatbot = window.renderizarListaChatbot || async function() {
            console.log('üé® [HTML STUB] renderizarListaChatbot chamada (vers√£o HTML)');
            const container = document.getElementById('lista-fichas-chatbot');
            if (!container) {
                console.error('‚ùå [HTML STUB] Container n√£o encontrado');
                return;
            }
            container.innerHTML = '<div class="loading-message">Carregando reclama√ß√µes...</div>';
            
            // Tentar usar a vers√£o completa se dispon√≠vel
            if (window._renderizarListaChatbotFull && typeof window._renderizarListaChatbotFull === 'function') {
                console.log('‚úÖ [HTML STUB] Usando vers√£o completa');
                return window._renderizarListaChatbotFull();
            }
            
            // Se n√£o houver vers√£o completa, tentar carregar fichas diretamente
            if (window.armazenamentoReclamacoes) {
                try {
                    const fichas = await window.armazenamentoReclamacoes.carregarTodos('chatbot');
                    console.log('üìã [HTML STUB] Fichas carregadas:', fichas.length);
                    if (fichas.length > 0) {
                        console.log('üìã [HTML STUB] Primeira ficha:', fichas[0]);
                        // Aguardar um pouco para garantir que criarCardChatbot esteja dispon√≠vel
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Tentar usar criarCardChatbot de v√°rias formas
                        let criarCard = null;
                        if (typeof window.criarCardChatbot === 'function') {
                            criarCard = window.criarCardChatbot;
                            console.log('‚úÖ [HTML STUB] Usando window.criarCardChatbot');
                        } else if (typeof criarCardChatbot === 'function') {
                            criarCard = criarCardChatbot;
                            console.log('‚úÖ [HTML STUB] Usando criarCardChatbot');
                        } else {
                            // Tentar novamente ap√≥s mais um delay
                            await new Promise(resolve => setTimeout(resolve, 500));
                            if (typeof window.criarCardChatbot === 'function') {
                                criarCard = window.criarCardChatbot;
                                console.log('‚úÖ [HTML STUB] Usando window.criarCardChatbot (ap√≥s delay)');
                            }
                        }
                        
                        if (criarCard) {
                            try {
                                const html = fichas.map(f => {
                                    console.log('üé® [HTML STUB] Criando card para ficha:', f.id);
                                    return criarCard(f);
                                }).join('');
                                console.log('üìù [HTML STUB] HTML gerado (primeiros 500 chars):', html.substring(0, 500));
                                container.innerHTML = html;
                                console.log('‚úÖ [HTML STUB] Cards renderizados com sucesso!');
                            } catch (error) {
                                console.error('‚ùå [HTML STUB] Erro ao criar cards:', error);
                                console.error('‚ùå [HTML STUB] Stack:', error.stack);
                                container.innerHTML = fichas.map(f => `<div class="ficha-card">${f.nomeCompleto || f.id || 'Sem nome'}</div>`).join('');
                            }
                        } else {
                            console.warn('‚ö†Ô∏è [HTML STUB] criarCardChatbot n√£o encontrado, usando HTML simples');
                            console.warn('‚ö†Ô∏è [HTML STUB] typeof window.criarCardChatbot:', typeof window.criarCardChatbot);
                            container.innerHTML = fichas.map(f => `<div class="ficha-card">${f.nomeCompleto || f.id || 'Sem nome'}</div>`).join('');
                        }
                    } else {
                        container.innerHTML = '<div class="no-results">Nenhuma reclama√ß√£o Chatbot cadastrada ainda</div>';
                    }
                } catch (error) {
                    console.error('‚ùå [HTML STUB] Erro ao carregar fichas:', error);
                    container.innerHTML = '<div class="no-results">Erro ao carregar reclama√ß√µes</div>';
                }
            } else {
                container.innerHTML = '<div class="no-results">Sistema de armazenamento n√£o dispon√≠vel</div>';
            }
        };
        console.log('‚úÖ [HTML] renderizarListaChatbot definida no HTML');
        
        // Definir criarCardChatbot no HTML tamb√©m para garantir disponibilidade
        // Usar o mesmo padr√£o das outras p√°ginas (complaint-item)
        if (!window.criarCardChatbot) {
            window.criarCardChatbot = function(ficha) {
                const statusLabels = {
                    'nao-iniciado': 'N√£o Iniciado',
                    'em-tratativa': 'Em Tratativa',
                    'concluido': 'Conclu√≠do',
                    'respondido': 'Respondido'
                };
                
                const canalLabels = {
                    'whatsapp': 'üì± WhatsApp',
                    'telegram': '‚úàÔ∏è Telegram',
                    'site': 'üåê Site',
                    'app': 'üì≤ App',
                    'outro': 'üîó Outro'
                };
                
                const statusClass = `status-${ficha.status || 'nao-iniciado'}`;
                const statusLabel = statusLabels[ficha.status] || ficha.status || 'N√£o Iniciado';
                const canalLabel = canalLabels[ficha.canalChatbot] || ficha.canalChatbot || 'N√£o informado';
                
                let badges = `<span class="chatbot-badge">ü§ñ Chatbot</span>`;
                if (ficha.resolvidoAutomaticamente) {
                    badges += '<span style="background: #1DFDB9; color: #000058; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">‚úÖ Auto</span>';
                }
                if (ficha.encaminhadoHumano) {
                    badges += '<span style="background: #1634FF; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">üë§ Humano</span>';
                }
                
                const dataFormatada = ficha.dataCriacao ? new Date(ficha.dataCriacao).toLocaleDateString('pt-BR') : 'N/A';
                const nome = ficha.nomeCompleto || ficha.nomeCliente || 'Nome n√£o informado';
                const cpf = ficha.cpf || 'N/A';
                const motivo = ficha.motivoReduzido || ficha.motivo || 'N√£o informado';
                const responsavel = ficha.responsavel || 'N√£o atribu√≠do';
                
                // Fun√ß√£o auxiliar para formatar data (se n√£o existir)
                const formatarData = (dataString) => {
                    if (!dataString) return 'N/A';
                    try {
                        return new Date(dataString).toLocaleDateString('pt-BR');
                    } catch {
                        return dataString;
                    }
                };
                
                // Escapar ID para uso seguro em onclick
                const fichaIdEscapado = ficha.id.replace(/'/g, "\\'");
                return `
                    <div class="complaint-item" onclick="abrirFichaChatbotHTML('${fichaIdEscapado}')">
                        <div class="complaint-header">
                            <div class="complaint-title">
                                ${nome}
                                ${badges}
                            </div>
                            <div class="complaint-status ${statusClass}">${statusLabel}</div>
                        </div>
                        <div class="complaint-summary">
                            <div class="complaint-detail"><strong>CPF:</strong> ${cpf}</div>
                            <div class="complaint-detail"><strong>Motivo:</strong> ${motivo}</div>
                            <div class="complaint-detail"><strong>Canal:</strong> ${canalLabel}</div>
                            <div class="complaint-detail"><strong>Data:</strong> ${dataFormatada}</div>
                            <div class="complaint-detail"><strong>Respons√°vel:</strong> ${responsavel}</div>
                        </div>
                    </div>
                `;
            };
            console.log('‚úÖ [HTML] criarCardChatbot definida no HTML (padr√£o complaint-item)');
        }
        
        // Fun√ß√£o auxiliar para abrir ficha (compat√≠vel com o sistema)
        window.abrirFichaChatbotHTML = function(id) {
            console.log('üîç [HTML] abrirFichaChatbotHTML chamado com ID:', id);
            if (window.abrirFichaChatbot && typeof window.abrirFichaChatbot === 'function') {
                window.abrirFichaChatbot(id);
            } else if (window.fichasEspecificas && window.fichasEspecificas.abrirFicha) {
                // Buscar a ficha primeiro
                if (window.armazenamentoReclamacoes) {
                    window.armazenamentoReclamacoes.obterPorId('chatbot', id).then(ficha => {
                        if (ficha) {
                            window.fichasEspecificas.abrirFicha(ficha);
                        } else {
                            console.error('‚ùå Ficha n√£o encontrada:', id);
                        }
                    });
                } else {
                    console.error('‚ùå armazenamentoReclamacoes n√£o dispon√≠vel');
                }
            } else if (window.FichasEspecificas) {
                // Criar inst√¢ncia se n√£o existir
                window.fichasEspecificas = new window.FichasEspecificas();
                if (window.armazenamentoReclamacoes) {
                    window.armazenamentoReclamacoes.obterPorId('chatbot', id).then(ficha => {
                        if (ficha) {
                            window.fichasEspecificas.abrirFicha(ficha);
            } else {
                            console.error('‚ùå Ficha n√£o encontrada:', id);
                        }
                    });
                } else {
                    console.error('‚ùå armazenamentoReclamacoes n√£o dispon√≠vel');
                }
            } else {
                // Aguardar um pouco e tentar novamente
                setTimeout(() => {
                    if (window.FichasEspecificas) {
                        window.fichasEspecificas = new window.FichasEspecificas();
                        if (window.armazenamentoReclamacoes) {
                            window.armazenamentoReclamacoes.obterPorId('chatbot', id).then(ficha => {
                                if (ficha) {
                                    window.fichasEspecificas.abrirFicha(ficha);
                                } else {
                                    console.error('‚ùå Ficha n√£o encontrada:', id);
                                }
                            });
                        }
                    } else {
                        console.error('‚ùå FichasEspecificas n√£o dispon√≠vel. Verifique se js/fichas-especificas.js est√° carregado.');
                    }
                }, 500);
            }
        };
        
        // Listener para atualizar lista quando uma nova ficha for salva
        window.addEventListener('reclamacaoSalva', function(event) {
            if (event.detail && event.detail.tipo === 'chatbot') {
                console.log('üì¢ [HTML] Evento reclamacaoSalva recebido para chatbot, atualizando lista...');
                setTimeout(() => {
                    if (window.renderizarListaChatbot) {
                        window.renderizarListaChatbot();
                    }
                }, 500);
            }
        });
        
        // Definir handleSubmitChatbot diretamente no HTML para garantir disponibilidade
        if (!window.handleSubmitChatbot) {
            window.handleSubmitChatbot = async function(e) {
                console.log('üöÄüöÄüöÄ [HTML] handleSubmitChatbot chamado (vers√£o HTML) üöÄüöÄüöÄ');
                if (e) {
                    e.preventDefault();
                }
                
                // Tentar usar a vers√£o completa se dispon√≠vel
                if (window._handleSubmitChatbotFull && typeof window._handleSubmitChatbotFull === 'function') {
                    console.log('‚úÖ [HTML] Usando vers√£o completa de handleSubmitChatbot');
                    return window._handleSubmitChatbotFull(e);
                }
                
                // Vers√£o HTML stub - coletar dados do formul√°rio e salvar
                try {
                    console.log('üìã [HTML] Coletando dados do formul√°rio...');
                    
                    // Fun√ß√£o auxiliar para obter valor de campo
                    const obterValor = (id) => {
                        const campo = document.getElementById(id);
                        return campo ? campo.value : '';
                    };
                    
                    // Fun√ß√£o auxiliar para obter checkbox
                    const obterCheckbox = (id) => {
                        const campo = document.getElementById(id);
                        return campo ? campo.checked : false;
                    };
                    
                    // Gerar ID
                    const id = window.armazenamentoReclamacoes ? 
                        window.armazenamentoReclamacoes.gerarId() : 
                        `rec_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    // Coletar dados do formul√°rio
                    const ficha = {
                        id: id,
                        tipoDemanda: 'chatbot',
                        nomeCompleto: obterValor('chatbot-nome') || '',
                        cpf: obterValor('chatbot-cpf'),
                        telefone: obterValor('chatbot-telefone') || '',
                        notaAvaliacao: obterValor('chatbot-nota-avaliacao'),
                        avaliacaoCliente: obterValor('chatbot-avaliacao-cliente'),
                        produto: obterValor('chatbot-produto'),
                        motivo: obterValor('chatbot-motivo'),
                        respostaBot: document.querySelector('input[name="chatbot-resposta-bot"]:checked')?.value || '',
                        observacaoRespostaBot: obterValor('chatbot-observacao-resposta-bot-texto') || '',
                        pixStatus: obterValor('chatbot-pix-status'),
                        enviarCobranca: document.querySelector('input[name="chatbot-enviar-cobranca"]:checked')?.value || 'N√£o',
                        casosCriticos: obterCheckbox('chatbot-casos-criticos'),
                        observacoes: obterValor('chatbot-observacoes'),
                        status: obterValor('chatbot-status') || 'nao-iniciado',
                        canalChatbot: obterValor('chatbot-canal') || '',
                        dataCriacao: new Date().toISOString(),
                        responsavel: window.sistemaPerfis?.usuarioAtual?.nome || window.sistemaPerfis?.usuarioAtual?.email || 'Sistema'
                    };
                    
                    console.log('üìã [HTML] Ficha coletada:', ficha);
                    
                    // Validar campos obrigat√≥rios
                    if (!ficha.nomeCompleto || !ficha.cpf) {
                        alert('Por favor, preencha pelo menos o nome e CPF');
                        return;
                    }
                    
                    // Salvar usando armazenamentoReclamacoes
                    if (!window.armazenamentoReclamacoes) {
                        alert('Erro: sistema de armazenamento n√£o dispon√≠vel');
                        return;
                    }
                    
                    console.log('üíæ [HTML] Salvando ficha...');
                    const sucesso = await window.armazenamentoReclamacoes.salvar('chatbot', ficha);
                    console.log('üì• [HTML] Resultado do salvar:', sucesso);
                    
                    if (!sucesso) {
                        alert('Erro ao salvar reclama√ß√£o');
                        return;
                    }
                    
                    console.log('‚úÖ [HTML] Ficha salva com sucesso!');
                    
                    // Limpar formul√°rio
                    const form = document.getElementById('form-chatbot');
                    if (form) {
                        form.reset();
                    }
                    
                    // Atualizar lista
                    if (window.renderizarListaChatbot) {
                        await window.renderizarListaChatbot();
                    }
                    
                    // Mostrar lista
                    if (window.mostrarSecao) {
                        window.mostrarSecao('lista-chatbot');
                    }
                    
                    alert('Reclama√ß√£o Chatbot salva com sucesso!');
                    
                } catch (error) {
                    console.error('‚ùå [HTML] Erro ao salvar:', error);
                    alert('Erro ao salvar reclama√ß√£o: ' + error.message);
                }
            };
            console.log('‚úÖ [HTML] handleSubmitChatbot definida no HTML');
        }
        
        // Garantir que o event listener do formul√°rio seja adicionado (mesmo com erro de sintaxe)
        (function configurarFormularioChatbot() {
            console.log('üîß [HTML] Configurando formul√°rio chatbot...');
            const form = document.getElementById('form-chatbot');
            if (form) {
                console.log('‚úÖ [HTML] Formul√°rio encontrado, adicionando listener...');
                form.addEventListener('submit', function(e) {
                    console.log('üöÄüöÄüöÄ [HTML] FORMUL√ÅRIO SUBMIT CHAMADO! üöÄüöÄüöÄ');
                    e.preventDefault();
                    console.log('‚úÖ [HTML] preventDefault executado');
                    
                    // Usar handleSubmitChatbot (agora sempre dispon√≠vel)
                    if (window.handleSubmitChatbot) {
                        console.log('‚úÖ [HTML] Chamando window.handleSubmitChatbot...');
                        window.handleSubmitChatbot(e);
                    } else {
                        console.error('‚ùå [HTML] window.handleSubmitChatbot n√£o est√° dispon√≠vel!');
                        alert('Erro: fun√ß√£o de salvamento n√£o est√° dispon√≠vel. Recarregue a p√°gina.');
                    }
                });
                console.log('‚úÖ [HTML] Event listener adicionado ao formul√°rio');
            } else {
                console.warn('‚ö†Ô∏è [HTML] Formul√°rio form-chatbot n√£o encontrado');
            }
        })();
        
        // Fun√ß√£o para mostrar/ocultar campo de observa√ß√£o quando selecionar "N√£o" em Resposta do Bot
        window.toggleObservacaoRespostaBot = function() {
            const respostaBot = document.querySelector('input[name="chatbot-resposta-bot"]:checked')?.value;
            const campoObservacao = document.getElementById('chatbot-observacao-resposta-bot');
            const campoTexto = document.getElementById('chatbot-observacao-resposta-bot-texto');
            
            if (respostaBot === 'N√£o' && campoObservacao) {
                campoObservacao.style.display = 'block';
                if (campoTexto) {
                    campoTexto.required = true;
                }
            } else {
                if (campoObservacao) {
                    campoObservacao.style.display = 'none';
                }
                if (campoTexto) {
                    campoTexto.required = false;
                    campoTexto.value = '';
                }
            }
        };
        
        // Verificar logs persistentes de salvamento ao carregar a p√°gina
        (function verificarLogsSalvamento() {
            console.log('üîç Verificando logs persistentes de salvamento...');
            const logs = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('velotax_salvamento_') || key.startsWith('velotax_debug_salvamento_'))) {
                    try {
                        const log = JSON.parse(localStorage.getItem(key));
                        logs.push({ key, ...log });
                    } catch (e) {
                        // Ignorar erros de parse
                    }
                }
            }
            if (logs.length > 0) {
                console.log('üìã Logs de salvamento encontrados:', logs);
                // Mostrar os √∫ltimos 5 logs
                const ultimosLogs = logs.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0)).slice(0, 5);
                console.table(ultimosLogs);
                
                // Se houver um salvamento recente (√∫ltimos 10 segundos), atualizar a lista
                const agora = Date.now();
                const salvamentoRecente = ultimosLogs.find(log => {
                    if (log.timestamp) {
                        const tempoLog = new Date(log.timestamp).getTime();
                        return (agora - tempoLog) < 10000; // 10 segundos
                    }
                    return false;
                });
                
                if (salvamentoRecente && salvamentoRecente.sucesso) {
                    console.log('üîÑ Salvamento recente detectado, atualizando lista...');
                    setTimeout(() => {
                        if (window.renderizarListaChatbot) {
                            window.renderizarListaChatbot();
                        }
                    }, 1000);
                }
            } else {
                console.log('üì≠ Nenhum log de salvamento encontrado');
            }
        })();
    </script>
    <script src="js/chatbot-page.js"></script>
    <script src="js/theme-toggle.js"></script>
    <script src="js/graficos-detalhados.js"></script>
    <script src="js/controle-graficos-dashboard.js"></script>
    <script src="js/lista-casos-abertos.js"></script>
    <script src="js/filtros-exportacao-csv.js"></script>
    <script src="js/exportacao-excel.js"></script>
    <!-- Script de Depura√ß√£o Firebase - Carregamento e Diagn√≥stico -->
    <script src="js/DEBUG_CARREGAMENTO_FIREBASE.js"></script>
    <script>
        // MIGRA√á√ÉO DE DADOS ANTIGOS (SEM RESETAR) - APENAS UMA VEZ
        (function() {
            // Verificar se j√° migrou (usar uma flag)
            const flagMigracao = 'velotax_migracao_concluida';
            if (localStorage.getItem(flagMigracao) === 'true') {
                console.log('‚úÖ Migra√ß√£o j√° foi conclu√≠da anteriormente. Pulando...');
                return;
            }
            
            console.log('üîÑ Verificando e migrando dados antigos (primeira vez)...');
            
            // Migrar dados das chaves antigas para as novas (sem apagar)
            const migracoes = [
                { antiga: 'velotax_demandas_bacen', nova: 'velotax_reclamacoes_bacen' },
                { antiga: 'velotax_demandas_n2', nova: 'velotax_reclamacoes_n2' },
                { antiga: 'velotax_demandas_chatbot', nova: 'velotax_reclamacoes_chatbot' }
            ];
            
            let migradas = 0;
            migracoes.forEach(({ antiga, nova }) => {
                const dadosAntigos = localStorage.getItem(antiga);
                const dadosNovos = localStorage.getItem(nova);
                
                if (dadosAntigos && !dadosNovos) {
                    try {
                        console.log(`üîÑ Migrando dados de ${antiga} para ${nova}...`);
                        const dados = JSON.parse(dadosAntigos);
                        if (Array.isArray(dados) && dados.length > 0) {
                            localStorage.setItem(nova, JSON.stringify(dados));
                            console.log(`‚úÖ ${dados.length} reclama√ß√µes migradas de ${antiga} para ${nova}`);
                            migradas++;
                            // Remover chave antiga apenas ap√≥s migra√ß√£o bem-sucedida
                            localStorage.removeItem(antiga);
                        }
                    } catch (error) {
                        console.error(`‚ùå Erro ao migrar ${antiga}:`, error);
                    }
                } else if (dadosAntigos && dadosNovos) {
                    // Se ambas existem, mesclar (evitar duplicatas)
                    try {
                        const antigos = JSON.parse(dadosAntigos);
                        const novos = JSON.parse(dadosNovos);
                        if (Array.isArray(antigos) && Array.isArray(novos)) {
                            const idsNovos = new Set(novos.map(n => n.id));
                            const paraAdicionar = antigos.filter(a => a.id && !idsNovos.has(a.id));
                            if (paraAdicionar.length > 0) {
                                const mesclados = [...novos, ...paraAdicionar];
                                localStorage.setItem(nova, JSON.stringify(mesclados));
                                console.log(`‚úÖ ${paraAdicionar.length} reclama√ß√µes mescladas de ${antiga} para ${nova}`);
                                migradas++;
                            }
                            localStorage.removeItem(antiga);
                        }
                    } catch (error) {
                        console.error(`‚ùå Erro ao mesclar ${antiga}:`, error);
                    }
                }
            });
            
            if (migradas > 0) {
                console.log(`‚úÖ ${migradas} migra√ß√µes conclu√≠das.`);
            } else {
                console.log('‚úÖ Nenhuma migra√ß√£o necess√°ria.');
            }
            
            // Marcar migra√ß√£o como conclu√≠da
            localStorage.setItem(flagMigracao, 'true');
        })();
        
        // Fun√ß√£o para adicionar m√∫ltiplos telefones (global)
        window.adicionarTelefone = function(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('Container n√£o encontrado:', containerId);
                return;
            }
            
            const telefoneDiv = document.createElement('div');
            telefoneDiv.className = 'telefone-item-multiplo';
            telefoneDiv.style.display = 'flex';
            telefoneDiv.style.gap = '8px';
            telefoneDiv.style.marginTop = '8px';
            telefoneDiv.innerHTML = `
                <input type="text" class="velohub-input telefone-mask telefone-input" placeholder="(00) 00000-0000" style="flex: 1;">
                <button type="button" onclick="this.parentElement.remove()" style="padding: 8px 12px; background: #ff4757; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úï</button>
            `;
            container.appendChild(telefoneDiv);
            
            // Aplicar m√°scara no novo campo
            if (window.aplicarMascaraTelefone) {
                const novoInput = telefoneDiv.querySelector('.telefone-mask');
                if (novoInput) {
                    window.aplicarMascaraTelefone(novoInput);
                }
            } else if (typeof formatPhone === 'function') {
                const novoInput = telefoneDiv.querySelector('.telefone-mask');
                if (novoInput) {
                    novoInput.addEventListener('input', formatPhone);
                }
            }
        };
        
        // Fun√ß√£o para coletar todos os telefones de um container (global)
        window.obterTelefonesDoContainer = function(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            
            const inputs = container.querySelectorAll('.telefone-input');
            const telefones = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(valor => valor.length > 0);
            
            return telefones;
        };
    </script>
    <script src="js/historico-cliente.js"></script>
    <script src="js/formulario-dinamico.js"></script>
    <script src="js/sistema-notificacoes.js"></script>
</body>
</html>

